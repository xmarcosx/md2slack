# Bug Investigation: Missing Content at Beginning of Slack Post

**Status**: âœ… RESOLVED (2026-01-10)
**Resolution**: Feature 007-default-chunking implemented auto-chunking and content preservation tests

## Observed Behavior

When running:
```bash
md2slack post -t "https://sla..." temp_files/ny.md
```

The Slack output starts at "Assessment Programs" (line 19 of markdown), missing:
- Title: `# New York State Assessment Data`
- Description text
- Horizontal rule
- `## Data Source` section with table
- Another horizontal rule

## Expected Behavior

The full content should be posted, starting with the title.

## Evidence Collected

| Check                          | Result                                      |
| :----------------------------- | :------------------------------------------ |
| Original markdown size         | 7,485 characters                            |
| Converted mrkdwn size          | 8,922 characters (under 40K limit)          |
| Converter output begins with   | `*New York State Assessment Data*` (correct)|
| Truncation triggered?          | No (content under limit)                    |
| `--chunk` flag used?           | No                                          |

## Verified: Code Appears Correct

1. **Converter (`converter.py`)**: Produces correct output with all content
2. **CLI non-chunked path (`cli.py:218-251`)**: Posts content directly without manipulation
3. **Slack client (`slack.py`)**: Passes text directly to `chat_postMessage`
4. **Truncation (`slack.py:156-169`)**: Only truncates at END, not beginning

## Possible Root Causes

### 1. Screenshot Shows Different Content
The screenshot may be showing:
- An older message in the thread (not the newly posted content)
- A different thread entirely
- Content that was already there before posting

**Verification**: Re-run the command and check the actual newly posted message URL

### 2. Slack Thread Reply Position
When posting with `thread_ts`, the new message is a REPLY, not the parent. The screenshot shows content at the "top" of the view, which might be the parent message, not the new reply.

**Verification**: Scroll down in the thread to see if the full content is in a later message

### 3. Slack API Behavior
Slack might be:
- Silently truncating from beginning (unlikely but possible)
- Interpreting some mrkdwn syntax in an unexpected way
- Having display issues with certain content patterns

**Verification**: Use Slack API to retrieve the posted message and compare with sent content

### 4. User-Facing Issue: Automatic Chunking
User's hunch: Chunking should be automatic for long content. Currently requires `--chunk` flag.

**Recommendation**: Consider auto-enabling chunking when content exceeds a threshold (e.g., 20K characters)

---

## Test Coverage Gap (Confirmed)

The test `test_chunk_posts_multiple_messages` only verifies:
```python
assert mock_client.post_message.call_count >= 2
assert "(1/" in first_text  # Only checks indicator presence
```

It does NOT verify:
- First chunk contains the beginning of the content
- All original content is preserved in correct order
- Number of posts matches expected chunk count

---

## Plan

### Phase 1: Reproduce and Debug

1. **Run with dry-run to see exact output**
   ```bash
   md2slack post -t "..." temp_files/ny.md --dry-run
   ```
   Verify the output contains the title and Data Source section.

2. **Post and capture the message URL**
   Re-run the post and note the exact permalink returned.

3. **Retrieve posted message via API**
   Use Slack API or web UI to view the actual message content.

4. **Compare sent vs received**
   Determine if content was lost during posting or just display issue.

### Phase 2: Fix and Test

Based on findings from Phase 1:

1. **If code bug**: Fix the root cause in the affected module

2. **Add comprehensive test for content preservation**:
   ```python
   def test_all_content_preserved_in_chunks():
       """Verify first chunk contains beginning of content."""
       content = "# Title\n\nIntro text.\n\n## Section One\n\n..."
       # ... chunking ...
       # Assert first chunk starts with "# Title" content
       # Assert all content is preserved across chunks
   ```

3. **Consider auto-chunking feature**:
   - Add `--auto-chunk` or make `--chunk` automatic when content exceeds threshold
   - This is a separate enhancement, not a bug fix

### Files to Modify

| File                   | Changes                                       |
| :--------------------- | :-------------------------------------------- |
| `tests/test_cli.py`    | Add content preservation test                 |
| `tests/test_chunker.py`| Add first-chunk-content verification          |
| TBD based on root cause| Bug fix if code issue found                   |

### Verification Steps

1. Run dry-run and verify output contains full content
2. Post to Slack and verify message contains full content
3. Run `uv run pytest` to ensure all tests pass
4. Manual test with `temp_files/ny.md` to confirm fix

---

## Resolution (2026-01-10) - Initial Fix

This bug investigation led to **Feature 007-default-chunking**, which addressed both the root cause analysis and the recommended fixes:

### Changes Made

1. **Auto-chunking is now default**: The `--chunk`/`-c` flag has been removed. Chunking is always enabled, handling both short and long content automatically.

2. **Content preservation tests added**:
   - `test_first_chunk_contains_document_beginning` - Verifies first chunk starts with original content
   - `test_all_words_preserved_across_chunks` - Verifies no content is lost during chunking
   - `test_chunk_order_matches_document_order` - Verifies chunk sequence matches document order

3. **Test coverage gap closed**: The existing chunking tests now verify content preservation, not just indicator presence.

---

## Bug Recurrence & Final Fix (2026-01-10)

The bug recurred because the initial fix set `DEFAULT_CHUNK_SIZE = 39000` (Slack's documented API limit), but **Slack silently splits messages over ~4046 characters server-side**.

### True Root Cause

Slack's `chat.postMessage` API has an **undocumented server-side limit of ~4046 characters**. Messages exceeding this are automatically split into multiple messages without any indication to the client. This caused:
- CLI reports posting 1 message
- Slack creates 3 messages (no indicators since we didn't add them)
- Content appears fragmented in the thread

Reference: https://github.com/slackapi/java-slack-sdk/issues/704

### Final Fix

| Change                       | Before          | After          |
| :--------------------------- | :-------------- | :------------- |
| `DEFAULT_CHUNK_SIZE`         | 39,000 chars    | 3,900 chars    |
| `MIN_CHUNK_SIZE`             | 1,000 chars     | 500 chars      |

### Verification

- All 152 tests pass
- `temp_files/ny.md` (8,922 chars) now splits into 3 chunks with proper `(1/3)`, `(2/3)`, `(3/3)` indicators
- First chunk correctly starts with document title

### Files Modified

| File                        | Changes                                              |
| :-------------------------- | :--------------------------------------------------- |
| `src/md2slack/chunker.py`   | Updated DEFAULT_CHUNK_SIZE to 3900, MIN to 500       |
| `tests/test_cli.py`         | Updated test comments and assertions                 |
| `tests/test_chunker.py`     | Updated MIN_CHUNK_SIZE test assertion                |

